---
title: "SmaRP: Smart Retirement Planning	"
date: \today
output: 
    pdf_document:
#      citation_package: natbib
#      fig_caption: true
#      keep_tex: true
      latex_engine: xelatex
      includes:
        in_header: header.tex
params:
      Salary: NA
      birthday: NA
      Road2Retirement: NA
      SalaryGrowthRate: NA
      CurrentP2: NA
      P2purchase: NA
      TypePurchase: NA
      rate: NA
      P3purchase: NA
      CurrentP3: NA
      returnP3: NA
      postalcode: NA
      Kanton: NA
      NKids: NA
      churchtax: NA
      rate_group: NA
      MaxContrTax: NA
      retirementdate: NA
      BarGraphData: NA
      TserieGraphData: NA
      RetirementAge: NA
      TaxRate: NA
      retirementfund: NA
      percentageLastSalary: NA
      PLZGemeinden: NA
      AHL: NA
      ALV: NA
      VersicherungsL: NA
      VersicherungsV: NA
      VersicherungsK: NA
      DOV: NA
      Kinder: NA
      Verheiratet: NA
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SmaRP)
library(ggplot2)
library(googleVis)
library(dplyr)
library(knitr)
library(kableExtra)
library(pander)
library(reshape2)
library(shiny)
library(lubridate)

show_text <- TRUE


if(params$P2purchase + params$P3purchase >0){
  show_tax = TRUE
} else {
  show_tax = FALSE
}

options(warn = -1)

DOV <- format(round(params$DOV, 2), nsmall = 2)
Verheiratet<- format(round(params$Verheiratet, 2), nsmall = 2)
VersicherungsV <- format(round(params$VersicherungsV, 2), nsmall = 2)
VersicherungsL <- format(round(params$VersicherungsL, 2), nsmall = 2)
ALV <- format(round(params$ALV, 2), nsmall = 2)
AHL <- format(round(params$AHL, 2), nsmall = 2)
Kinder <- format(round(params$Kinder, 2), nsmall = 2)

```


SmaRP, **Sma**rt **R**etirement **P**lanning has been designed and developed by [Mirai Solutions GmbH](www.mirai-solutions.com) to support users in an educated decision-making process towards their retirement.

The SmaRP code is available on [GitHub](https://github.com/miraisolutions/SmaRP.git).

The SmaRP app is available online at http://mirai-solutions.ch/apps/smarp/.

# Main Results


```{r deduction_percentage, echo = FALSE}
Road2Retirement_to_print <- params$Road2Retirement %>%
  select(calendar, ExpectedSalaryPath, BVGcontriburionrates, BVGContributions, BVGpurchase, DirectP2, ReturnP2, TotalP2, P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3, DirectTax, ReturnTax, TotalTax, Total) %>%
  rename(P2ContributionPath = BVGContributions) %>%
  rename(P2contriburionrates = BVGcontriburionrates) %>%
  rename(P2purchase = BVGpurchase) %>%
  mutate(Y = year(calendar)/5)%>%
  filter(Y %in% unique(c(Y[1], Y[!Y%%1], Y[length(Y)])) ) 
```

The total retirement fund as of `r params$retirementdate` is `r printCurrency(params$retirementfund)` `r  params$percentageLastSalary`.

This plot represents the time-evolution of the different contributions to the total retirement fund.

```{r timeSeriesPlot, echo = FALSE}
tserieGraphData.columns <- setdiff(names(params$TserieGraphData), "calendar")

tserieGraphData.long <- melt(params$TserieGraphData,
                             id = "calendar",
                             measure = tserieGraphData.columns)
tserieGraphData.long$variable <- factor(tserieGraphData.long$variable,
                                        levels = sort(unique(tserieGraphData.long$variable),
                                                      decreasing = TRUE))

ggplot(tserieGraphData.long, aes(x = calendar, y = value, fill = variable)) +
  scale_fill_manual(NULL, values = c("OccupationalPension" = "#008cc3", "PrivatePension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = NULL, y = NULL) +
  geom_area(alpha = 0.6) +
  theme(
    aspect.ratio = 0.6,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = "grey80"),
    panel.ontop = FALSE
  )
```

This plot represents the percentage of  each contribution to the total retirement fund.

```{r barPlot, echo = FALSE}
barGraphData.columns <- setdiff(names(params$BarGraphData), "contribution")
barGraphData.columns <- grep("annotation$", barGraphData.columns,
                             value = TRUE, invert = TRUE)
barGraphData.long <- melt(params$BarGraphData,
                          id = "contribution",
                          measure = barGraphData.columns)
barGraphData.long$variable <- factor(barGraphData.long$variable,
                                     levels = sort(barGraphData.long$variable,
                                                   decreasing = TRUE))

ggplot(data = barGraphData.long, aes(x = contribution, y = value, fill = variable, label = value)) +
  geom_bar(stat = "identity", alpha = 0.6) +
  geom_text(aes(label = sprintf("%1.0f%%", 100 * value)), size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  scale_fill_manual(NULL, values = c("OccupationalPension" = "#008cc3", "PrivatePension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  labs(x = NULL, y = NULL) +
  theme(
    aspect.ratio = 0.1,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = NA),
    panel.ontop = FALSE
  )
```


# Assumptions and limitations

SmaRP is based on the Swiss retirement system. Most of the functionalities are generic, but the basic configuration and parameters are specific of Switzerland.

SmaRP applies only to employees, i.e. persons whose main income is a salary. Self-employed people are not considered.

SmaRP takes into account ONLY the occupational pension fund (Pillar II in Switzerland) and a private fund (Pillar III in Switzerland), those where one can teke decisions during the working career. The state-run pay-as-you-earn system (Pillar I) is law and salary dependent only, meaning there is no active decision-making from the employee which could affect it. Therefore, it is not explicitly considered in SmaRP.

SmaRP takes into consideration the tax saving generated by the voluntary retirement contributions, assuming that all tax benefits generated are 100% reinvested as an additional fund. The return of these tax benefits is assumed to be the same as those of the private pension fund.

In case of married and double-income couples, the aggregated amonunt of all variables should be entered and a 50% income distribution is assumed.  

When calculating the tax savings, a proxy of the taxable income is used. 
The taxable income is computed  by detracting from the gross salary the following deductions: 

* Old-age and survivor's insurance (AHV/AVS): `r AHL`
* Unemployment, accident and invalidity insurance (ALV): `r ALV`
* Deduction for:
  * Health insurance: `r VersicherungsL` plus `r VersicherungsV`
  * Married people: `r Verheiratet`
  * Married people with double income: `r DOV`
  * Deduction per child: `r Kinder`

In case of voluntary contributions to pension funds, those contributions are deducted as well.

The input and output values are expressed in monetary units and assumed to be of the same currency. No currency conversion is applied in SmaRP. 


```{r swissOrGeneralCase, child = if (show_text) 'swiss-case.Rmd' else 'general-case.Rmd'} 
``` 


# Results

The time-dependent data is shown in the following tables.

```{r Road2Retirement_to_print_Summarized, echo = FALSE}
moncols <- c(  "ExpectedSalary", "OccupationalPension", "PrivatePension", "TaxBenefits") 
set.caption('Detailed Private Pension Fund Contribution')
Road2Retirement_to_print_Summarized <- Road2Retirement_to_print %>%
  mutate(TaxBenefits = TotalTax) %>%
  mutate(OccupationalPension = DirectP2 + ReturnP2) %>%
  mutate(PrivatePension = DirectP3 + ReturnP3) %>%
  rename(ExpectedSalary = ExpectedSalaryPath) %>%
  select(calendar,ExpectedSalary, OccupationalPension, PrivatePension, TaxBenefits) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Summarized)
```

```{r Road2Retirement_to_print_Pillar2, echo = FALSE, eval=show_text, include=show_text}
if (show_text){
moncols <- c(  "P2ContributionPath", "P2purchase", "DirectP2", "ReturnP2", "TotalP2") 
set.caption('Detailed Occupational Pension Fund Contribution')
Road2Retirement_to_print_Pillar2 <- Road2Retirement_to_print %>%
  select(calendar,  P2ContributionPath, P2purchase, DirectP2, ReturnP2, TotalP2) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar2)
}
```

```{r Road2Retirement_to_print_Pillar3, echo = FALSE, eval=show_text, include=show_text}
moncols <- c(  "P3ContributionPath", "P3purchase", "DirectP3", "ReturnP3", "TotalP3") 
set.caption('Detailed Provate Pension Fund Contribution')
Road2Retirement_to_print_Pillar3 <- Road2Retirement_to_print %>%
  select(calendar,  P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar3)
```

```{r Road2Retirement_to_print_TaxBenefit, echo = FALSE, eval=show_tax, include=show_tax}
moncols <- c(  "DirectTax", "ReturnTax", "TotalTax") 
set.caption('Detailed Tax Benefit Contribution')
Road2Retirement_to_print_TaxBenefit <- Road2Retirement_to_print %>%
  select(calendar, DirectTax, ReturnTax, TotalTax)%>%
  makeTable(moncols)
pander(Road2Retirement_to_print_TaxBenefit)
```

# Disclaimer
All figures in this report should be understood as general references and are not binding in any case.
Mirai Solutions offers no guarantees for the completeness or accuracy of the information in this report and declines any responsibility in case of mistakes.
