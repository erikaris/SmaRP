---
title: "SmaRP: Smart Retirement Planning	"
date: \today
output: 
    pdf_document:
#      citation_package: natbib
#      fig_caption: true
#      keep_tex: true
      latex_engine: xelatex
      includes:
        in_header: header.tex
params:
      Salary: NA
      birthday: NA
      Road2Retirement: NA
      SalaryGrowthRate: NA
      CurrentP2: NA
      P2purchase: NA
      TypePurchase: NA
      rate: NA
      P3purchase: NA
      CurrentP3: NA
      returnP3: NA
      postalcode: NA
      gemeinden: NA
      Kanton: NA
      NKids: NA
      churchtax: NA
      rate_group: NA
      MaxContrTax: NA
      retirementdate: NA
      BarGraphData: NA
      TserieGraphData: NA
      RetirementAge: NA
      TaxRate: NA
      retirementfund: NA
      percentageLastSalary: NA
      PLZGemeinden: NA
      AHL: NA
      ALV: NA
      VersicherungsL: NA
      VersicherungsV: NA
      VersicherungsK: NA
      DOV: NA
      Kinder: NA
      Verheiratet: NA
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SmaRP)
library(ggplot2)
library(googleVis)
library(dplyr)
library(knitr)
library(kableExtra)
library(pander)
library(reshape2)
library(shiny)
library(lubridate)

show_text <- TRUE


if(params$P2purchase + params$P3purchase >0){
  show_tax = TRUE
} else {
  show_tax = FALSE
}

options(warn = -1)

DOV <- format(round(params$DOV, 2), nsmall = 0)
Verheiratet<- format(round(params$Verheiratet, 2), nsmall = 0)
VersicherungsV <- format(round(params$VersicherungsV, 2), nsmall = 0)
VersicherungsL <- format(round(params$VersicherungsL, 2), nsmall = 0)
ALV <- format(round(params$ALV, 2), nsmall = 0)
AHL <- format(round(params$AHL, 2), nsmall = 0)
Kinder <- format(round(params$Kinder, 2), nsmall = 0)

```


SmaRP, **Sma**rt **R**etirement **P**lanning has been designed and developed by [Mirai Solutions GmbH](www.mirai-solutions.com) to support people living in Switzerlan in an educated decision-making process towards their retirement.

The SmaRP code is available on [GitHub](https://github.com/miraisolutions/SmaRP.git).

The SmaRP app is available online at http://mirai-solutions.ch/apps/smarp/.

# 1. Main Results


```{r deduction_percentage, echo = FALSE}
Road2Retirement_to_print <- params$Road2Retirement %>%
  select(calendar, ExpectedSalaryPath, BVGcontriburionrates, BVGContributions, BVGpurchase, DirectP2, ReturnP2, TotalP2, P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3, DirectTax, ReturnTax, TotalTax, Total) %>%
  rename(P2ContributionPath = BVGContributions) %>%
  rename(P2contriburionrates = BVGcontriburionrates) %>%
  rename(P2purchase = BVGpurchase) %>%
  mutate(Y = year(calendar)/5)%>%
  filter(Y %in% unique(c(Y[1], Y[!Y%%1], Y[length(Y)])) ) 
```

The total retirement fund as of `r format(params$retirementdate, "%d-%m-%Y") ` is `r printCurrency(params$retirementfund)` swiss francs `r  params$percentageLastSalary`.

The two plots bellow represent the time-evolution of the different funds and their contribution to the total retirement fund at retirement. 

```{r timeSeriesPlot, echo = FALSE}
tserieGraphData.columns <- setdiff(names(params$TserieGraphData), "calendar")

tserieGraphData.long <- melt(params$TserieGraphData,
                             id = "calendar",
                             measure = tserieGraphData.columns)
tserieGraphData.long$variable <- factor(tserieGraphData.long$variable,
                                        levels = sort(unique(tserieGraphData.long$variable),
                                                      decreasing = TRUE))

ggplot(tserieGraphData.long, aes(x = calendar, y = value, fill = variable)) +
  scale_fill_manual(NULL, values = c("OccupationalPension" = "#008cc3", "PrivatePension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = NULL, y = NULL) +
  geom_area(alpha = 0.6) +
  theme(
    aspect.ratio = 0.6,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = "grey80"),
    panel.ontop = FALSE
  )
```


```{r barPlot, echo = FALSE}
barGraphData.columns <- setdiff(names(params$BarGraphData), "contribution")
barGraphData.columns <- grep("annotation$", barGraphData.columns,
                             value = TRUE, invert = TRUE)
barGraphData.long <- melt(params$BarGraphData,
                          id = "contribution",
                          measure = barGraphData.columns)
barGraphData.long$variable <- factor(barGraphData.long$variable,
                                     levels = sort(barGraphData.long$variable,
                                                   decreasing = TRUE))

ggplot(data = barGraphData.long, aes(x = contribution, y = value, fill = variable, label = value)) +
  geom_bar(stat = "identity", alpha = 0.6) +
  geom_text(aes(label = sprintf("%1.0f%%", 100 * value)), size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  scale_fill_manual(NULL, values = c("OccupationalPension" = "#008cc3", "PrivatePension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  labs(x = NULL, y = NULL) +
  theme(
    aspect.ratio = 0.1,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = NA),
    panel.ontop = FALSE,
    legend.position = "none"
  )
```

# 2. Parameters

```{r, echo = FALSE}
TypePurchase <- ifelse(params$TypePurchase =="SingleP2", "single purchase", "annual purchase")
```

Input parameters are:

* Residence in `r params$gemeinden`, `r params$Kanton`, postal code `r params$postalcode`.

* The date of birth provided as input is `r params$birthday`.

* With a retirement age of `r params$RetirementAge`, the retirement year is `r params$retirementdate`.

* The current salary is `r params$Salary` CHF, with a growth rate of `r params$SalaryGrowthRate/100`%, which is assumed constant until retirement.

* The occupational pension fund (Pillar II) has a current amount of `r params$CurrentP2` CHF.

```{r msgP2, echo=FALSE}
if(is.null(params$P2purchase)){
  msgP2 <- "No voluntary contributions to the Pillar II"
} else {
  msgP2 <- paste0("The voluntary contribution to the Pillar II is of ", params$P2purchase, " CHF, and is purchased as a ", TypePurchase, ".")
}
```
* `r msgP2`.

* The interest rate of of the Pillar II is given by `r params$rate/100`%, and we ensure that the amount considered in the calculation is always higher than the minimum required by law.

* The private pension fund (Pillar III) has a current amount of `r params$CurrentP3` CHF.

* The annual contribution to the Pillar III is of `r params$P3purchase` CHF, with an expected return of `r params$returnP3/100`%.

```{r maritallabel, echo=FALSE}
if(params$rate_group == "A"){
  maritallabel <- "Single"
} else if(params$rate_group == "B"){
  maritallabel <- "Married"
} else {
  maritallabel <- "Married double-income"
}
```

* The user's marital status is `r maritallabel`, with  `r params$NKids`  children.

```{r churchaffiliation, echo = FALSE}
if (params$churchtax == "N"){
  churchaffiliation <- "no"
} else {
  churchaffiliation <- "a"
}
```

* The user declares to have `r churchaffiliation` church affiliation. [^1]



# 3. Assumptions and limitations


SmaRP applies only to employees, i.e. persons whose main income is a salary. Self-employed people are not considered.

SmaRP takes into account ONLY the occupational pension fund (Pillar II in Switzerland) and a private fund (Pillar III in Switzerland), those where one can make decisions during the working career. The state-run pay-as-you-earn system (Pillar I) is law and salary dependent only, meaning there is no active decision-making from the employee which could affect it. Therefore, it is not explicitly considered in SmaRP.

SmaRP takes into consideration the tax saving generated by the voluntary retirement contributions, assuming that all tax benefits generated are 100% reinvested as an additional fund. The return of these tax benefits is assumed to be the same as those of the private pension fund.

In case of married and double-income couples, the aggregated amonunt of all variables should be entered and a 50% income distribution is assumed.  

When calculating the tax savings, a proxy of the taxable income is used. [^2] 
The taxable income is computed  by detracting from the gross salary the following deductions: [^3]

* Old-age and survivor's insurance (AHV/AVS).
* Unemployment, accident and invalidity insurance (ALV).
* Deductions for:
  + Health insurance
  + Civil status: Married, Married double income or singles.
  + Kids

In case of voluntary contributions to pension funds, those contributions are deducted as well.


# 4. The basics of the Swiss retirement system


The Swiss social retirement system is based on a three-pillar regime. A nice summary can be found [here](https://en.wikipedia.org/wiki/Pension_system_in_Switzerland).

\begin{center}
\includegraphics[width=0.4\textwidth]{www/SwissRetirementSystem.png}
\end{center}

The first Pillar is a state- run pay-as-you-earn system with minimum benefits. It is law and salary dependent only and it is not expliciedly considered in SmaRP.

The Pillar II is a compulsory, tax-deductible company occupational pension insurance fund. Voluntary additional Pillar II buy-ins are regulated, but allow for benefits improvement at retirement age while reducing the tax burden during the working career. 

The voluntary contribution (Pillar III) is a privately-run, tax-deductible insurance fund. The private pension fund is modelled as an asset of a given amount ("Current assets"), to which contributions can be added annually (Annual contribution). The annual expected return of such asset is given as an input and assumed constant until the retirement date.

Since the tax benefits are always a key factor of a smart retirement project, SmaRP takes them into consideration and are implemented as an additional fund.

\begin{center}
\includegraphics[width=0.6\textwidth]{www/TaxBenefits.png}
\end{center}

The taxation is  municipality-dependent. It can either be provided as an input or inferred from the user provided inputs.
If inferred, it is computed as two parts: the federal tax that is the same for all kantons, and kantonal tax that depends on the kanton. 
The kantonal tax  is further modulated at municipality level via a factor. 
An ulterior contribution to the kantonal tax is given by the optional affiliation to a church.

The retirement age can either be explicitedly provided as an input, or can be inferred from the genere.


# 5. Sources


[BVG law - ](https://www.admin.ch/opc/de/classified-compilation/19820152/index.html)
https://www.admin.ch/opc/de/classified-compilation/19820152/index.html

[AHV - ](https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-62487.html)
https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-62487.html

[Mindestzinssatz - ](https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-64228.html)
https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-64228.html

[Swiss Tax System - ](https://www.estv.admin.ch/estv/de/home/allgemein/steuerinformationen/dienstleistungen/publikationen-und-formulare-bestellen.html)
https://www.estv.admin.ch/estv/de/home/allgemein/steuerinformationen/dienstleistungen/publikationen-und-formulare-bestellen.html


[^1]: In certain kantons there is a different church tax based on the type of church the user belongs to (Evangelische Kirche and Roeman-katolische Kirche). SmaRP does not make such distinction and always assumes the highest of the values. Moreover, when the church-tax depends on the kantonal tax rate (instead of being a fixed factor), an approximation is made and treated as the maximum possible factor (relevant for kantons: VS, BS, BL). 
[^2]: Tax on assets are not considered.
[^3]: Although most of those parameters can vary a bit depending on the kanton, we use the federal values as proxy.


# Appendix 1: Methodology


## Pillar II

The savings process for retirement benefits starts on January 1 following the year in which the person turns 24.

$$ PensionableSalary(t) = max(Salary(t) - \frac{7}{8} AHV Salary(t), 30 * AHVSalary) $$ [^4]

Contribution Rates under Pillar II are defined by law[^5] (art.16)
\begin{center}
\begin{tabular}{ c | c | c | c }
\hline
    &  &   &   \\
  25-34 & 35-44 & 45-54 & 55-64/65 \\ \hline
    &  &   &   \\
  7\% & 10\% & 15\% & 18\% \\
    &  &   &   \\
  \hline
\end{tabular}
\end{center}

$$ MandatoryContributions(t) = PensionableSalary(t) * ContributionRate(t) $$

$$ r = 1\% $$[^6]

$$ Pillar II = \sum_{t0}^T(Mandatory Contributions + Voluntary Contributions) * \exp^{r*(T-t)} $$


## Private pension fund Pillar III

The private pension fund ($PillarIII$) at year $t$ is calculated as:

$$ PillarIII (t)=  \sum_{t=t_0}^TVoluntaryContributions * e^{r(T-t)} $$

where $VoluntaryContributions$ is provided as input,  $r$ is the interest rate applied to the private pension fund, $t_0$ is today, and $T$ is the retirement age.

## Tax Benefit

The tax benefit ($TaxBenefit$) at year $t$, if the marginal tax rate is provided as an input ($TaxRate$), is calculated as:

$$ TaxBenefit(t) = \sum_{t_0}^TVoluntaryContributions(t) *  TaxRate(t) * e^{r(T-t)} $$

where $VoluntaryContributions$ is provided as input, $t_0$ is today, and $T$ is the retirement age.

If the tax rate is not provided as an input, the tax benefits are computed as:

$$ TaxBenefit(t) = TaxPaid_{Salary}(t) - TaxPaid_{TaxableIncome}(t) $$[^7]

The $TaxPaid$ is a function that calculates the amount of taxes to pay given a certain income. The tax benefit is the difference between the taxes due for the salary and those due once all deductions are considered (taxable income).

In SmaRP the taxable income ($TaxableIncome$) at time $t$ is computed as:

$$ TaxableIncome(t) = max(Salary(t) - min(TotalContr, MaxContrTax),0) $$

where $Salary(t)$ is the salary at year $t$, $TotalContr$ is the sum of the Pillar II and Pillar III purchases and $MaxContrTax$ is the maximum deductable amount allowed by law.


### The TaxPaid function

The $TaxPaid$ function is the sum of the federal and kantonal taxes.

The Federal tax at year $t$ is computed as:

$$ FederalTax(t) = \sum_{t_0}^T(Income(t) *  FederalTaxRate) - 251*Nkids $$

where $Income(t)$ is the income at time $t$, $Nkids$ is the number of kids under 18 and $FederalTaxRate$ is a factor based on the civil status and family structure.

<!-- The Federal tax rate can be looked up in the following table. -->

The kantonal tax at year $t$ is computed as:

$$ KantonalTax(t) = \sum_{t_0}^T(Income(t) *  KantonalTaxRate) * (F_{kanton} + F_{municipality} + F_{church)} $$

where $Income(t)$ is the income at time $t$, $KantonalTaxRate$ is a factor based on the civil status and family structure,  $F_{kanton}$ is a kanton-dependent multiplication factor, $F_{municipality}$ is a municipality-dependent  multiplication factor and $F_{church}$ is a curch affiliation dependent multiplication factor.

<!-- The Kantonal tax rate for kanton `r params$Kanton` can be looked up in the following table. -->


```{r taxRates, echo = FALSE}
fkanton <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorKanton"]
gemeinde_name <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "GDENAME"]
fgemeinde <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorGemeinde"]
fkirche <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorKirche"]
```

The kanton-dependent multiplication factor for kanton `r params$Kanton` is `r fkanton`.

The municipality-dependent multiplication factor for municipality `r gemeinde_name` is `r fgemeinde`.

The curch affiliation dependent multiplication factor for municipality `r gemeinde_name` is `r fkirche`. If there is no church affiliation this factor is ```0```.

[^4]: AHV salary: 2350 month, 28200 year.
[^5]: 831.40. Bundesgesetz über die berufliche Alters-, Hinterlassenen- und Invalidenvorsorge (Art.16)
[^6]: Minimum interest rate on the retirement assets as of. 01.01.2017
[^7]: The taxable income does not correspond to the net or gross salary. Social insurance contributions and a wide range of other deductions are substracted from the gross salary. The amount remaining is the taxable income, the base to calculate your tax bill.


# Appendix 2: Detailed Results

The time-dependent data is shown in the following tables.

```{r Road2Retirement_to_print_Summarized, echo = FALSE}
moncols <- c(  "ExpectedSalary", "OccupationalPension", "PrivatePension", "TaxBenefits") 
set.caption('Detailed Private Pension Fund Contribution')
Road2Retirement_to_print_Summarized <- Road2Retirement_to_print %>%
  mutate(TaxBenefits = TotalTax) %>%
  mutate(OccupationalPension = DirectP2 + ReturnP2) %>%
  mutate(PrivatePension = DirectP3 + ReturnP3) %>%
  rename(ExpectedSalary = ExpectedSalaryPath) %>%
  select(calendar,ExpectedSalary, OccupationalPension, PrivatePension, TaxBenefits) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Summarized)
```

```{r Road2Retirement_to_print_Pillar2, echo = FALSE, eval=show_text, include=show_text}
if (show_text){
moncols <- c(  "P2ContributionPath", "P2purchase", "DirectP2", "ReturnP2", "TotalP2") 
set.caption('Detailed Occupational Pension Fund Contribution')
Road2Retirement_to_print_Pillar2 <- Road2Retirement_to_print %>%
  select(calendar,  P2ContributionPath, P2purchase, DirectP2, ReturnP2, TotalP2) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar2)
}
```

```{r Road2Retirement_to_print_Pillar3, echo = FALSE, eval=show_text, include=show_text}
moncols <- c(  "P3ContributionPath", "P3purchase", "DirectP3", "ReturnP3", "TotalP3") 
set.caption('Detailed Provate Pension Fund Contribution')
Road2Retirement_to_print_Pillar3 <- Road2Retirement_to_print %>%
  select(calendar,  P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar3)
```

```{r Road2Retirement_to_print_TaxBenefit, echo = FALSE, eval=show_tax, include=show_tax}
moncols <- c(  "DirectTax", "ReturnTax", "TotalTax") 
set.caption('Detailed Tax Benefit Contribution')
Road2Retirement_to_print_TaxBenefit <- Road2Retirement_to_print %>%
  select(calendar, DirectTax, ReturnTax, TotalTax)%>%
  makeTable(moncols)
pander(Road2Retirement_to_print_TaxBenefit)
```

# Disclaimer
All figures in this report should be understood as general references and are not binding in any case.
Mirai Solutions offers no guarantees for the completeness or accuracy of the information in this report and declines any responsibility in case of mistakes.
