---
# title: 
# date: 
output: 
    pdf_document:
#      citation_package: natbib
#      fig_caption: true
#      keep_tex: true
      latex_engine: xelatex
      includes:
        in_header: header.tex
params:
      Salary: NA
      birthday: NA
      Road2Retirement: NA
      SalaryGrowthRate: NA
      CurrentP2: NA
      P2purchase: NA
      TypePurchase: NA
      rate: NA
      P3purchase: NA
      CurrentP3: NA
      returnP3: NA
      postalcode: NA
      gemeinden: NA
      Kanton: NA
      NChildren: NA
      churchtax: NA
      rate_group: NA
      MaxContrTax: NA
      retirementdate: NA
      BarGraphData: NA
      TserieGraphData: NA
      RetirementAge: NA
      TaxRate: NA
      retirementfund: NA
      percentageLastSalary: NA
      PLZGemeinden: NA
      AHL: NA
      ALV: NA
      VersicherungsL: NA
      VersicherungsV: NA
      VersicherungsK: NA
      DOV: NA
      Kinder: NA
      Verheiratet: NA
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SmaRP)
library(ggplot2)
library(googleVis)
library(dplyr)
library(knitr)
library(kableExtra)
library(pander)
library(reshape2)
library(shiny)
library(lubridate)

show_text <- TRUE


if(params$P2purchase + params$P3purchase >0){
  show_tax = TRUE
} else {
  show_tax = FALSE
}

options(warn = -1)

DOV <- format(round(params$DOV, 2), nsmall = 0)
Verheiratet<- format(round(params$Verheiratet, 2), nsmall = 0)
VersicherungsV <- format(round(params$VersicherungsV, 2), nsmall = 0)
VersicherungsL <- format(round(params$VersicherungsL, 2), nsmall = 0)
ALV <- format(round(params$ALV, 2), nsmall = 0)
AHL <- format(round(params$AHL, 2), nsmall = 0)
Kinder <- format(round(params$Kinder, 2), nsmall = 0)

```

\def\SmaRPVersion{`r get_SmaRP_version()`}

\newpage

\vspace*{7cm}
\begin{center}
\large{SmaRP: Smart Retirement Planning}
\end{center}
\begin{center}
\normalsize{Mirai Solutions GmbH}
\end{center}
\begin{center}
\today
\end{center}
\newpage

\tableofcontents

\newpage

# Introduction

Smart Retirement Planning (**SmaRP**) is a [Mirai Solutions](https://mirai-solutions.ch/) initiative designed to guide people working in Switzerland towards a strategic decision-making process for their retirement.

**SmaRP** is based on the [Swiss pension system](https://en.wikipedia.org/wiki/Pension_system_in_Switzerland) and reflects the complexity of its legal framework.

It is implemented as an [R Shiny](https://shiny.rstudio.com/) pension calculator web app, in the form of an R package. The source code is available on [GitHub](https://github.com/miraisolutions/SmaRP.git) and the app itself online at http://mirai-solutions.ch/apps/smarp/.

<br>

# 1. Main Results


```{r deduction_percentage, echo = FALSE}
Road2Retirement_to_print <- params$Road2Retirement %>%
  select(Calendar, ExpectedSalaryPath, BVGcontributionrates, BVGContributions, BVGpurchase, DirectP2, ReturnP2, TotalP2, P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3, DirectTax, ReturnTax, TotalTax, Total) %>%
  rename(P2ContributionPath = BVGContributions) %>%
  rename(P2contriburionrates = BVGcontributionrates) %>%
  rename(P2purchase = BVGpurchase) %>%
  mutate(Y = year(Calendar)/5)%>%
  filter(Y %in% unique(c(Y[1], Y[!Y%%1], Y[length(Y)])) ) 
```

The total retirement fund as of `r format(params$retirementdate, "%d-%m-%Y")` is **`r printCurrency(params$retirementfund)` CHF**, `r  params$percentageLastSalary`.

The two plots below represent the time evolution of the different funds and their contribution to the total retirement fund at retirement, respectively. 

<br>


```{r timeSeriesPlot, echo = FALSE}
tserieGraphData.columns <- setdiff(names(params$TserieGraphData), "Calendar")

tserieGraphData.long <- melt(params$TserieGraphData,
                             id = "Calendar",
                             measure = tserieGraphData.columns)
tserieGraphData.long$variable <- factor(tserieGraphData.long$variable,
                                        levels = sort(unique(tserieGraphData.long$variable),
                                                      decreasing = TRUE))

ggplot(tserieGraphData.long, aes(x = Calendar, y = value, fill = variable)) +
  scale_fill_manual(NULL, values = c("Occupational_Pension" = "#008cc3", "Private_Pension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = NULL, y = NULL) +
  geom_area(alpha = 0.6) +
  theme(
    aspect.ratio = 0.6,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = "grey80"),
    panel.ontop = FALSE
  )
```


```{r barPlot, echo = FALSE}
barGraphData.columns <- setdiff(names(params$BarGraphData), "contribution")
barGraphData.columns <- grep("annotation$", barGraphData.columns,
                             value = TRUE, invert = TRUE)
barGraphData.long <- melt(params$BarGraphData,
                          id = "contribution",
                          measure = barGraphData.columns)
barGraphData.long$variable <- factor(barGraphData.long$variable,
                                     levels = sort(barGraphData.long$variable,
                                                   decreasing = TRUE))

ggplot(data = barGraphData.long, aes(x = contribution, y = value, fill = variable, label = value)) +
  geom_bar(stat = "identity", alpha = 0.6) +
  geom_text(aes(label = sprintf("%1.0f%%", 100 * value)), size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  scale_fill_manual(NULL, values = c("Occupational_Pension" = "#008cc3", "Private_Pension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  labs(x = NULL, y = NULL) +
  theme(
    aspect.ratio = 0.1,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = NA),
    panel.ontop = FALSE,
    legend.position = "none"
  )
```

<br>

# 2. Parameters

```{r, echo = FALSE}
TypePurchase <- ifelse(params$TypePurchase =="SingleP2", "single purchase", "annual purchase")
```

Here is a list of all inputs:

* Residence is in `r params$gemeinden`, `r params$Kanton`, postal code `r params$postalcode`
* The date of birth is `r format(params$birthday, "%d-%m-%Y")`
* At the age of `r params$RetirementAge`, the retirement year is `r format(params$retirementdate, "%d-%m-%Y")`
```{r, echo=FALSE}
SalaryGrowthRate <-  params$SalaryGrowthRate * 100
```
* The current salary is **`r printCurrency(params$Salary)` CHF**, with a growth rate of `r SalaryGrowthRate`%, which is assumed constant until retirement
* The occupational pension fund (Pillar II) is of **`r printCurrency(params$CurrentP2)` CHF**
```{r msgP2, echo=FALSE}
if(is.null(params$P2purchase) || params$P2purchase == 0){
  msgP2 <- "No voluntary contributions to the Pillar II"
} else {
  msgP2 <- paste0("The voluntary contribution to Pillar II is of ", params$P2purchase, " CHF and is made as a ", TypePurchase, ".")
}
```
* `r msgP2`
* Pillar II has an interest rate of `r params$rate*100`%. We ensure that the amount considered in the calculation is always higher than the minimum required by law
* The private pension fund (Pillar III) is of `r printCurrency(params$CurrentP3)` CHF
* The annual contribution to the Pillar III is of `r printCurrency(params$P3purchase)` CHF, with an expected return of `r params$returnP3*100`%
```{r maritallabel, echo=FALSE}
if(params$rate_group == "A"){
  maritallabel <- "Single"
} else if(params$rate_group == "B"){
  maritallabel <- "Married"
} else {
  maritallabel <- "Married double-income"
}
```
* Civil status is `r maritallabel` with  `r params$NChildren`  children.

```{r churchaffiliation, echo = FALSE}
if (params$churchtax == "N"){
  churchaffiliation <- "No"
} else {
  churchaffiliation <- "A"
}
```

* `r churchaffiliation` church affiliation.[^1]


<br>

# 3. Assumptions and limitations


SmaRP is valid for employees only, i.e. persons whose main income is a salary. Self-employed people do not belong to this category.

SmaRP takes into account only the occupational pension fund (Pillar II) and a private fund (Pillar III). The state-run pay-as-you-earn system (Pillar I) is law and salary dependent only, meaning there is no active decision-making from the employee's side. Therefore, it is not explicitly considered.

SmaRP takes into account the tax saving generated by the voluntary retirement contributions, assuming that all tax benefits generated are 100% reinvested as an additional fund. The return from these tax benefits is assumed to be the same as those of the private pension fund.

SmaRP assumes a 50% income distribution in case of married and double-income couples.

A proxy of the taxable income is used to calculate tax savings.[^2] The taxable income is computed  by detracting the following deductions from the gross salary:[^3]

* Old-age and survivor's insurance (AHV/AVS)
* Unemployment, accident and invalidity insurance (ALV)
* Health insurance
* Civil status: Married, Married double income or singles
* Children
* Any additional voluntary contributions.

# 4. The basics of the Swiss retirement system


The Swiss social retirement system is based on a three-pillar regime. 


\vspace{12pt}


\begin{center}
\includegraphics[width=0.4\textwidth]{www/SwissRetirementSystem.png}
\end{center}


\vspace{12pt}

 
Pillar I is a state-run pay-as-you-earn system with minimum benefits. It is law and salary dependent only and it is not explicitly considered in this analysis.

Pillar II is a compulsory, tax-deductible company occupational pension insurance fund. Voluntary additional Pillar II buy-ins are regulated, but allow for benefits enhancements at retirement age while reducing the tax burden during the working career. 

Pillar III is a voluntary contribution; it is a privately-run, tax-deductible insurance fund. The private pension fund is modeled as an asset of a given amount ("Current assets"), to which contributions can be added annually (Annual contribution). The annual expected return of such asset is given as an input and assumed constant until the retirement date.

Tax benefits are always a key factor towards a smart retirement project. SmaRP takes them into consideration and implements them as an additional fund.


\vspace{12pt}


\begin{center}
\includegraphics[width=0.6\textwidth]{www/TaxBenefits.png}
\end{center}


\vspace{12pt}


Taxation is municipality-dependent. It can be either provided as an input or inferred from the user's inputs.
If inferred, it is computed in two parts: federal tax (same for all cantons) and cantonal tax (different in each canton). 
A third tax is calculated by multiplying to the cantonal tax with a municipality-specific percentage rate. 
An additional contribution to the cantonal tax is given by the optional affiliation to a church.

Retirement age can be either explicitly provided as an input or inferred from the gender.

[^1]: Church taxes differ based on the type (Evangelical or Roman Catholic Church) and canton of residence. SmaRP does not make such distinction and always assumes the highest of the values. Moreover, when the church-tax depends on the cantonal tax rate (instead of being a fixed factor), an approximation is made and treated as the maximum possible factor (relevant for cantons: VS, BS, BL). 
[^2]: Tax on assets are not considered.
[^3]: Although most of those parameters can vary a bit depending on the canton, we use the federal values as proxy.

\newpage

# Bibliography

Der Bundesratdas Portal Der Schweizer Regierung
Bundeskanzlei P - \url{https://www.admin.ch/opc/de/classified-compilation/19820152/index.html}

Der Bundesrat - \url{https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-62487.html}

Der Bundesrat - \url{https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-64228.html}

Publikationen Und Formulare Bestellen Eidgenössische ESTV - \url{https://www.estv.admin.ch/estv/de/home/allgemein/steuerinformationen/dienstleistungen/publikationen-und-formulare-bestellen.html}

\newpage
# Disclaimer

While **SmaRP** was developed under the utmost care and diligence, Mirai Solutions does not guarantee for its accuracy and correctness. In addition, **SmaRP** is based on assumptions and projections and as such computed figures should be understood as general references and do not hold any legal value.

\newpage

# Appendix 1: Methodology


## Pillar II

The savings process for retirement benefits starts on January 1st following the year in which the person turns 24[^4].

$$ PensionableSalary(t) = max(Salary(t) - \frac{7}{8} AHV Salary(t), 30 \cdot AHVSalary) $$

Contribution Rates under Pillar II are defined by law.[^5][^6]
\begin{center}
\begin{tabular}{ c | c | c | c }
\hline
    &  &   &   \\
  25-34 & 35-44 & 45-54 & 55-64/65 \\ \hline
    &  &   &   \\
  7\% & 10\% & 15\% & 18\% \\
    &  &   &   \\
  \hline
\end{tabular}
\end{center}

$$ MandatoryContributions(t) = PensionableSalary(t) \cdot ContributionRate(t) $$

$$ r = 1\% $$

$$ Pillar II = \sum_{t0}^T(Mandatory Contributions + Voluntary Contributions) \cdot \exp^{r(T-t)} $$


## Pillar III

The private pension fund ($PillarIII$) at year $t$ is calculated as:

$$ PillarIII (t)=  \sum_{t=t_0}^TVoluntaryContributions \cdot e^{r(T-t)} $$

where

- $VoluntaryContributions$ is a voluntary contribution amount,
- $r$ is the interest rate applied to the private pension fund,
- $t_0$ is today's date,
- $T$ is the retirement age.

## Tax Benefit

Granted that the marginal tax rate ($TaxRate$) is provided as an input, the tax benefit ($TaxBenefit$) at year $t$ is calculated as following:

$$ TaxBenefit(t) = \sum_{t_0}^TVoluntaryContributions(t) \cdot TaxRate(t) \cdot e^{r(T-t)} $$

where

- $VoluntaryContributions$ is an input,
- $t_0$ is today's date,
- $T$ is the retirement age.

If the tax rate is not an input, the tax benefits are computed as following[^7]:

$$ TaxBenefit(t) = TaxPaid_{Salary}(t) - TaxPaid_{TaxableIncome}(t) $$

The $TaxPaid$ calculates the amount of taxes to pay given a certain income. The tax benefit is the difference between the taxes due for the salary and those due once all deductions are considered (taxable income).

Taxable income ($TaxableIncome$) at time $t$ is computed as following:

$$ TaxableIncome(t) = max(Salary(t) - min(TotalContr, MaxContrTax),0) $$

where

- $Salary(t)$ is the salary at year $t$,
- $TotalContr$ is the sum of the Pillar II and Pillar III purchases,
- $MaxContrTax$ is the maximum deductible amount allowed by law.


### The TaxPaid function

The $TaxPaid$ function is the sum of the federal and cantonal taxes.

The Federal tax at year $t$ is computed as following:

$$ FederalTax(t) = \sum_{t_0}^T(Income(t) \cdot FederalTaxRate) - 251 \cdot NChildren $$

where

- $Income(t)$ is the income at time $t$,
- $NChildren$ is the number of kids under 18,
- $FederalTaxRate$ is a factor based on the civil status and family structure.

<!-- The Federal tax rate can be looked up in the following table. -->

The cantonal tax at year $t$ is computed as following:

$$ KantonalTax(t) = \sum_{t_0}^T(Income(t) \cdot  KantonalTaxRate) \cdot (F_{kanton} + F_{municipality} + F_{church)} $$

where

- $Income(t)$ is the income at time $t$,
- $KantonalTaxRate$ is a factor based on the civil status and family structure,
- $F_{kanton}$ is a canton-dependent multiplication factor,
- $F_{municipality}$ is a municipality-dependent  multiplication factor, 
- $F_{church}$ is a church affiliation dependent multiplication factor.

<!-- The cantonal tax rate for canton `r params$Kanton` can be looked up in the following table. -->


```{r taxRates, echo = FALSE}
fkanton <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorKanton"]
gemeinde_name <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "GDENAME"]
fgemeinde <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorGemeinde"]
fkirche <- params$PLZGemeinden[params$PLZGemeinden$PLZ==params$postalcode, "FactorKirche"]
```

The canton-dependent multiplication factor for canton `r params$Kanton` is `r fkanton`.

The municipality-dependent multiplication factor for municipality  `r gemeinde_name`  is  `r fgemeinde`.

The church affiliation dependent multiplication factor for municipality `r gemeinde_name` is `r fkirche`. In case of no church affiliation, this factor is  `0`.

[^4]: AHV salary: 2350 month, 28200 year.
[^5]: 831.40. Bundesgesetz über die berufliche Alters-, Hinterlassenen- und Invalidenvorsorge (Art.16).
[^6]: Minimum interest rate on the retirement assets as of 01.01.2017.
[^7]: The taxable income does not correspond to the net or gross salary. Social insurance contributions and a wide range of other deductions are subtracted from the gross salary. The amount remaining is the taxable income, the base to calculate your tax bill.

\newpage

# Appendix 2: Detailed Results

Detailed results from calculations are shown in the following tables.

```{r Road2Retirement_to_print_Summarized, echo = FALSE}
moncols <- c("Salary", "Occupational Pension", "Private Pension", "Tax Benefits") 
set.caption('Detailed Private Pension Fund Contribution')
Road2Retirement_to_print_Summarized <- Road2Retirement_to_print %>%
  mutate(`Tax Benefits` = TotalTax) %>%
  mutate(`Occupational Pension` = DirectP2 + ReturnP2) %>%
  mutate(`Private Pension` = DirectP3 + ReturnP3) %>%
  rename(`Salary` = ExpectedSalaryPath) %>%
  select(Calendar, `Salary`, `Occupational Pension`, `Private Pension`, `Tax Benefits`) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Summarized)
```

```{r Road2Retirement_to_print_Pillar2, echo = FALSE, eval=show_text, include=show_text}
if (show_text){
moncols <- c("P2 Contribution", "P2 purchase", "Direct P2", "Return P2", "Total P2") 
set.caption('Detailed Occupational Pension Fund Contribution')
Road2Retirement_to_print_Pillar2 <- Road2Retirement_to_print %>%
  rename(`P2 Contribution` = P2ContributionPath) %>%
  rename(`P2 purchase` = P2purchase) %>%
  rename(`Direct P2` = DirectP2) %>%
  rename(`Return P2` = ReturnP2) %>%
  rename(`Total P2` = TotalP2) %>%
  select(Calendar,  `P2 Contribution`, `P2 purchase`, `Direct P2`, `Return P2`, `Total P2`) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar2)
}
```

```{r Road2Retirement_to_print_Pillar3, echo = FALSE, eval=show_text, include=show_text}
moncols <- c("P3 Contribution", "P3 purchase", "Direct P3", "Return P3", "Total P3") 
set.caption('Detailed Private Pension Fund Contribution')
Road2Retirement_to_print_Pillar3 <- Road2Retirement_to_print %>%
  rename(`P3 Contribution` = P3ContributionPath) %>%
  rename(`P3 purchase` = P3purchase) %>%
  rename(`Direct P3` = DirectP3) %>%
  rename(`Return P3` = ReturnP3) %>%
  rename(`Total P3` = TotalP3) %>%
  select(Calendar,  `P3 Contribution`, `P3 purchase`, `Direct P3`, `Return P3`, `Total P3`) %>%
  makeTable(moncols)
pander(Road2Retirement_to_print_Pillar3)
```

```{r Road2Retirement_to_print_TaxBenefit, echo = FALSE, eval=show_tax, include=show_tax}
moncols <- c("Direct Tax", "Return Tax", "Total Tax") 
set.caption('Detailed Tax Benefit Contribution')
Road2Retirement_to_print_TaxBenefit <- Road2Retirement_to_print %>%
  rename(`Direct Tax` = DirectTax) %>%
  rename(`Return Tax` = ReturnTax) %>%
  rename(`Total Tax` = TotalTax) %>%
  select(Calendar, `Direct Tax`, `Return Tax`, `Total Tax`)%>%
  makeTable(moncols)
pander(Road2Retirement_to_print_TaxBenefit)
```
