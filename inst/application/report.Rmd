---
title: "SmaRP: Smart Retirement Planning	"
date: \today
output: 
    pdf_document:
#      citation_package: natbib
#      fig_caption: true
#      keep_tex: true
      latex_engine: xelatex
      includes:
        in_header: header.tex
params:
      Salary: NA
      birthday: NA
      Road2Retirement: NA
      SalaryGrowthRate: NA
      CurrentP2: NA
      P2purchase: NA
      TypePurchase: NA
      rate: NA
      P3purchase: NA
      CurrentP3: NA
      returnP3: NA
      postalcode: NA
      Kanton: NA
      NKids: NA
      churchtax: NA
      rate_group: NA
      MaxContrTax: NA
      retirementdate: NA
      BarGraphData: NA
      TserieGraphData: NA
      RetirementAge: NA
      TaxRate: NA
      case: NA
      retirementfund: NA
      percentageLastSalary: NA
      # tax_rates_Kanton_list: NA
      # BundessteueTabelle: NA
      PLZGemeinden: NA
      deduction_percentage: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(googleVis)
library(dplyr)
library(knitr)
library(kableExtra)
library(pander)
library(shiny)
library(lubridate)


if (params$case=="General"){
  show_text <- FALSE
} else {
  show_text <- TRUE
}

if(params$P2purchase + params$P3purchase >0){
  show_tax = TRUE
} else {
  show_tax = FALSE
}

# Convert to Monetary data type ----------------------------------------------------------------
printCurrency <- function(value,  digits=0, sep=",", decimal=".") { #currency.sym ="",
  paste(
    #currency.sym,
    formatC(value, format = "f", big.mark = sep, digits=digits, decimal.mark=decimal),
    sep=""
  )
}


# Make table -------------------------------------------------------------

makeTable <- function(Road2Retirement, moncols){ #, currency=""
  TableMonetary <- Road2Retirement[, c("calendar", moncols)] %>%
    mutate(calendar = paste(year(calendar), month(calendar, label = TRUE), sep = "-"))
  TableMonetary[, moncols] <- sapply(TableMonetary[, moncols], printCurrency) #, currency
  return(TableMonetary)
}

options(warn = -1)
```


SmaRP, **Sma**rt **R**etirement **P**lanning has been designed and developed by [Mirai Solutions GmbH](www.mirai-solutions.com) to support users in an educated decision-making process towards their retirement.

The SmaRP code is available on [GitHub](https://github.com/miraisolutions/SmaRP.git).

The SmaRP app is available online at http://mirai-solutions.ch/apps/smarp/.

# Main Results


```{r, echo = FALSE}
plot2 <-  gvisBarChart(
      chartid = "plot2",
      data = params$BarGraphData,
      xvar = "contribution",
      yvar= colnames(params$BarGraphData)[!grepl("contribution", colnames(params$BarGraphData))],
      options = list(width = 1200, height = 300, isStacked = TRUE, vAxes = "[{minValue:0}]", 
                     legend = "none", colors="['#008cc3', '#FF9966', '#13991c']", opacity = 0.3)
    )

 plot1 <-   gvisAreaChart(
      chartid = "plot1",
      data = params$TserieGraphData,
      xvar = "calendar",
      yvar = colnames(params$TserieGraphData)[which(colnames(params$TserieGraphData)!="calendar")],
      options = list(wwidth = 1200, height = 500, isStacked = TRUE, legend = "bottom", colors="['#008cc3', '#FF9966', '#13991c']")
    ) 

Road2Retirement_to_print <- params$Road2Retirement %>%
  select(calendar, ExpectedSalaryPath, BVGcontriburionrates, BVGContributions, BVGpurchase, DirectP2, ReturnP2, TotalP2, P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3, DirectTax, ReturnTax, TotalTax, Total) %>%
  rename(P2ContributionPath = BVGContributions) %>%
  rename(P2contriburionrates = BVGcontriburionrates) %>%
  rename(P2purchase = BVGpurchase) %>%
  mutate(Y = year(calendar)/5)%>%
  filter(Y %in% unique(c(Y[1], Y[!Y%%1], Y[length(Y)])) ) 

deduction_percentage <- 100*params$deduction_percentage
```

The total retirement fund as of `r params$retirementdate` is `r printCurrency(params$retirementfund)` `r  params$percentageLastSalary`.

This plot represent the time-evolution of the different contributions to the total retirement fund.

```{r, echo = FALSE}
webshot::webshot(plot(plot1), file = "TimeSeriesPlot.png", delay = 5)
```

This plot represent the percentage of  each contribution to the total retirement fund.

```{r}
webshot::webshot(plot(plot2), file = "BarChart.png", delay = 5)
```


# Assumptions and limitations

Please note that SmaRP was originally based on the Swiss retirement system. Most of the functionalities are generic, but the basic configuration and parameters are specifics of Switzerland.
The General case is obtained by turning off Swiss-specific modules.

SmaRP applies only to employees, i.e. persons whose main income is a salary. Self-employed people, who are subject to a different taxation regime, are not considered.

The state-run pay-as-you-earn system (Pillar I) is common to most developed countries and it is law and salary dependent only, meaning there is no active decision-making from the employee which could affect it. 

Therefore, it is not explicitly considered in SmaRP, where only those sections the user can have an impact on are shown.

SmaRP takes into consideration the tax saving generated by the voluntary retirement contributions, assuming that all tax benefits generated are 100% reinvested as an additional fund. The return of these tax benefits is assumed to be the same as those of the private pension fund.

When calculating the tax savings, a proxy of the taxable income is used. 
The taxable income is computed  by detracting from the gross salary the social security and other mandatory deductions. The deductions are estimated as `r deduction_percentage`% of the gross salary.
To calculate the tax benefits, we detract from the taxable income the minimum between the maximum deductible amount allowed by law and the total purchase of pension funds.

The input and output values are expressed in monetary units and assumed to be of the same currency. No currency conversion is applied in SmaRP. 


```{r test, child = if (show_text) 'swiss-case.Rmd' else 'general-case.Rmd'} 
``` 


# Results

The time-dependent data is shown in the following tables.
<!-- ```{r} -->
<!-- kable(params$Road2Retirement,  format = "latex", booktabs = TRUE, caption = "Time progress of Retirement Pension Fund")  %>% -->
<!--           kable_styling(latex_options = "scale_down") -->
<!-- ``` -->


```{r, echo = FALSE}
moncols <- c(  "ExpectedSalary", "OccupationalPension", "PrivatePension", "TaxBenefits") 
set.caption('Detailed Private Pension Fund Contribution')
Road2Retirement_to_print_Summarized <- Road2Retirement_to_print %>%
  mutate(TaxBenefits = TotalTax) %>%
  mutate(OccupationalPension = DirectP2 + ReturnP2) %>%
  mutate(PrivatePension = DirectP3 + ReturnP3) %>%
  rename(ExpectedSalary = ExpectedSalaryPath) %>%
  select(calendar,ExpectedSalary, OccupationalPension, PrivatePension, TaxBenefits) %>%
  makeTable(., moncols)
pander(Road2Retirement_to_print_Summarized)
```

```{r, echo = FALSE, eval=show_text, include=show_text}
if (show_text){
moncols <- c(  "P2ContributionPath", "P2purchase", "DirectP2", "ReturnP2", "TotalP2") 
set.caption('Detailed Occupational Pension Fund Contribution')
Road2Retirement_to_print_Pillar2 <- Road2Retirement_to_print %>%
  select(calendar,  P2ContributionPath, P2purchase, DirectP2, ReturnP2, TotalP2) %>%
  makeTable(., moncols)
pander(Road2Retirement_to_print_Pillar2)
}
```

```{r, echo = FALSE, eval=show_text, include=show_text}
moncols <- c(  "P3ContributionPath", "P3purchase", "DirectP3", "ReturnP3", "TotalP3") 
set.caption('Detailed Provate Pension Fund Contribution')
Road2Retirement_to_print_Pillar3 <- Road2Retirement_to_print %>%
  select(calendar,  P3ContributionPath, P3purchase, DirectP3, ReturnP3, TotalP3) %>%
  makeTable(., moncols)
pander(Road2Retirement_to_print_Pillar3)
```

```{r, echo = FALSE, eval=show_tax, include=show_tax}
moncols <- c(  "DirectTax", "ReturnTax", "TotalTax") 
set.caption('Detailed Tax Benefit Contribution')
Road2Retirement_to_print_TaxBenefit <- Road2Retirement_to_print %>%
  select(calendar, DirectTax, ReturnTax, TotalTax)%>%
  makeTable(., moncols)
pander(Road2Retirement_to_print_TaxBenefit)
```

# Disclaimer
All figures in this report should be understood as general references and are not binding in any case.
Mirai Solutions offers no guarantees for the completeness or accuracy of the information in this report and declines any responsibility in case of mistakes.
