---
title: "Dynamic Report"
date: \today
output: 
    pdf_document:
#      citation_package: natbib
#      fig_caption: true
#      keep_tex: true
      latex_engine: xelatex
      includes:
        in_header: header.tex
params:
      Salary: NA
      birthday: NA
      Road2Retirement: NA
      SalaryGrowthRate: NA
      CurrentP2: NA
      P2purchase: NA
      TypePurchase: NA
      rate: NA
      P3purchase: NA
      CurrentP3: NA
      returnP3: NA
      postalcode: NA
      Kanton: NA
      Tariff: NA
      NKids: NA
      churchtax: NA
      rate_group: NA
      MaxContrTax: NA
      retirementdate: NA
      BarGraphData: NA
      TserieGraphData: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(googleVis)
library(reshape)
library(ggplot2)
library(dplyr)
library(knitr)
library(kableExtra)
library(pander)
```


# SmarP calculation


Disclaimer: The results of this calculations do not have any legal value.

## Theory

Here goes some theory on how we compute the results

## Inputs

Given the Inputs:

* Salary

```{r, echo = FALSE}
params$Salary
```

* Birthdate

```{r, echo = FALSE}
params$birthday
```

* Salary Growth Rate
```{r, echo = FALSE}
params$SalaryGrowthRate
```

* CurrentPillar II

```{r, echo = FALSE}
params$CurrentP2
```

* Amount of Pillar II purchase

```{r, echo = FALSE}
params$P2purchase
```

* Type of Pillar II purchase

```{r, echo = FALSE}
params$TypePurchase
```

* (Tax?) Rate

```{r, echo = FALSE}
params$rate
```

* Amount of Pillar III purchase

```{r, echo = FALSE}
params$P3purchase
```

* Current Pillar III

```{r, echo = FALSE}
params$CurrentP3
```

* Pillar III return

```{r, echo = FALSE}
params$returnP3
```

* Postal Code of residence

```{r, echo = FALSE}
params$postalcode
```

* Kanton of residence

```{r, echo = FALSE}
params$Kanton
```

* Tariff

```{r, echo = FALSE}
params$Tariff
```

* Number of Kids

```{r, echo = FALSE}
params$NKids
```

* Church Affiliation
```{r, echo = FALSE}
params$churchtax
```

* Rate Group
```{r, echo = FALSE}
params$rate_group
```

* Maximum of Tax contribution

```{r, echo = FALSE}
params$MaxContrTax
```

* Desired Retirement Date

```{r, echo = FALSE}
params$retirementdate
```


## Output

BarPlot

```{r, echo = FALSE}
# plot2 <- gvisBarChart( data = params$BarGraphData,
#              xvar = "contribution",
#              yvar= colnames(params$BarGraphData)[!grepl("contribution", colnames(params$BarGraphData))],
#              options = list(width = 1200, height = 300, isStacked = TRUE, vAxes = "[{minValue:0}]", legend = "none"),
#              system("wkhtmltoimage -n --enable-javascript --javascript-delay 2000 data/plot2.html data/plot2.png ")
#     )
BarGraphData <- as.data.frame( params$BarGraphData)
yvar= c("DirectP2", "ReturnP2", "DirectP3", "ReturnP3", "DirectTax", "ReturnTax")
usedyvar<- colnames(BarGraphData)[colnames(BarGraphData) %in% yvar]
bardata <- BarGraphData %>% select(c(usedyvar, "contribution"))
bardata <- bardata %>%  melt( id ="contribution") %>% select(c(variable, value))
bar <- ggplot(bardata, aes(x=1, y=value, fill=variable)) + geom_bar(stat="identity",
            position = position_fill(reverse = TRUE)) + coord_flip() + labs(x="", y="percentage %", fill="contribution")
```

```{r}
plot(bar)
```

Timeseries Plot

```{r, echo = FALSE}
# plot1 <- gvisAreaChart(
#       data = TserieGraphData(),
#       xvar = "calendar",
#       yvar = colnames(TserieGraphData()[,-1]),
#       options = list(width = 1200, height = 500, isStacked = TRUE, legend = "bottom")
#     )
Tserie <- params$TserieGraphData

for(i in 2:length(usedyvar)){
  Tserie[usedyvar[i]] <- Tserie[usedyvar[i]] + Tserie[usedyvar[i-1]]
}
Tserie <- Tserie %>%
          melt( id ="calendar")

p <- ggplot(Tserie, aes(x=calendar, y=value, col=variable)) + geom_area(aes(fill=variable)) + xlab("years")
```
```{r}
plot(p)
```

Tabular Results

<!-- ```{r} -->
<!-- kable(params$Road2Retirement,  format = "latex", booktabs = TRUE, caption = "Time progress of Retirement Pension Fund")  %>% -->
<!--           kable_styling(latex_options = "scale_down") -->
<!-- ``` -->

```{r, echo = FALSE}
set.caption('Road2Retirement')
pander(params$Road2Retirement)
```