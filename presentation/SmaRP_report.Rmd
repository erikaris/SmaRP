## Report Findings

The shiny app is the perfect environment to try out multiple scenarios.

However, one might be interested in taking snapshots of the app results with given input combinations.

This can be done by:

- downloading data from the app
- building a report from the app

 **SmaRP** has both options integrated.
 
## |

```{r SmaRP-app3, echo = FALSE}
source(system.file("application","global.R", package = "SmaRP"))
shinyAppDir(
  system.file("application", package = "SmaRP"),
  options = list(
    width = "100%", height = 1000
  )
)
```


## Downloding Tabular Data

Downloading data in shiny is straight-forward. Shiny provides the `downloadButton` widget and the corresponding reactive function `downloadHandler()` to perform the download.

```{r download-button, echo = TRUE, eval = TRUE}
downloadButton(outputId = "data_download",
               label = "Download Data")
```

```{r download-handler, echo = TRUE, eval = FALSE}
output$data_download <- downloadHandler(
  filename = dataname(),
  content = function(file) {
    write.csv( Road2Retirement(),
               file,
               row.names = FALSE)})
```

## Building a report

The report is built with as an `rmarkdown` document. 
The document integrates pre-written text and code that gets evaluated upon report creation. 
The parameters are passed to the report from the app itself in the form of a reactive list `params()`.

```{r report, echo = TRUE, eval = FALSE}
output$report <- downloadHandler(
  filename = reportname(),
  content = function(file) {
      rmarkdown::render(
        input = "report.Rmd",
        output_file = file,
        output_format = "pdf_document",
        params = params()
      )}) 
```

Used in **SmaRP** to clarify the methodology and the assumptions made.

## Additional Advantages in Report

The report is implemented in `rmarkdown` and can integrate `LaTeX`. As a result:

* Easy structure & multiple output formats
* Explanatory text & in line code evaluation
* Dynamic file name
* Mathematical formulas
* Code blocks and computation
* Scripted plots & tables
* Footnotes & Bibliography

## Report example

```{r report-app, echo = FALSE}
source(system.file("application","global.R", package = "SmaRP"))
shinyAppDir(
  "./report-application/",
  options = list(
    width = "120%", height = 1000
  )
)
```


## Plots in the App

The plots in the app are generated with `googleVis`, an R package to easily make interactive plots and [Google's chart tools](https://developers.google.com/chart/) outlooks. 

The `googleVis` plots are integrated in the shiny app through the reactive function `renderGvis()`.

```{r bargraph-out, echo = FALSE, eval = TRUE}
source(system.file("application","global.R", package = "SmaRP"))
BarGraphData <- readRDS("../inst/application/BarGraphData.RDS")
miraiColors <- "['#008cc3', '#FF9966', '#13991c']"
ui <- fluidPage(
  htmlOutput("plot_final")
)
server <- function(input, output) {
  output$plot_final <- renderGvis({
    gvisBarChart(
      chartid = "plot_final",
      data = BarGraphData,
      xvar = "contribution",
      yvar = colnames(BarGraphData)[!grepl("contribution", colnames(BarGraphData))],
      options = list(
        width = 600, 
        height = 100,
        chartArea = "{left: '18.75%', width: '68.75%'}",
        isStacked = TRUE,
        vAxes = "[{minValue:0}]",
        hAxis = "{format:'#,###%'}",
        legend = "none",
        colors = miraiColors,
        dataOpacity = 0.3,
        bar = "{groupWidth: '100%'}",
        annotations = "{highContrast: 'false', textStyle: {bold: true}}"
      )
    )
  })
}
shinyApp(ui = ui, server = server)
```


* Pros: Nice outlook, automatic labels and mouseovers.
* Cons: Does not render outside of a browser

## Plots in the Report

<div style = "position: absolute;  z-index: 1;">
Report is static and does not need interactive plots.
Capturing the `googleVis` plots and integrating them in the report is not straightforward.
Therefore plots are built with `ggplot2`. 
</div>

<div style = "margin-top:-20px; position: absolute;  z-index: -1;">
```{r bargraph-out-ggplot, echo = FALSE, eval = TRUE}
barGraphData.long <- readRDS("../inst/application/barGraphData.long.RDS")
ggplot(data = barGraphData.long, aes(x = contribution, y = value, fill = variable, label = value)) +
  geom_bar(stat = "identity", alpha = 0.6) +
  geom_text(aes(label = sprintf("%1.0f%%", 100 * value)), size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  scale_fill_manual(NULL, values = c("Occupational Pension" = "#008cc3", "Private Pension" = "#FF9966", "TaxBenefits" = "#13991c")) +
  labs(x = NULL, y = "% Contribution of each fund at retirement") +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(color="grey"),
    aspect.ratio = 0.1,
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_line(colour = NA),
    panel.ontop = FALSE,
    legend.position = "none"
  )
```

</div>
